# EllipticFourierDescriptor
Python implementation and interpretation of "Elliptic Fourier Features of a Closed Contour" with enhanced start point and rotation normalization methods.

# 1 Introduction
Python implementation and interpretation of "Elliptic Fourier Features of a Closed Contour" with enhanced start point and rotation normalization methods.
In the code, the point having the maimum distance from the centroid is selected as the start point and the rotation is normalized by aligning the start point with horizontal axis of the coordiante system

# 2 Dependency and installation
The code only depends on numpy, thus any python environment having numpy installed is feasible to run the code.
Download the file "EllipticFourier.py" and copy the file to your working direction.

# 3 Usage
Given a closed contour of a shape, generated by e.g. OpenCV, this package can fit a Fourier series approximating the shape of the contour.

# 4 References
1. Frank P Kuhl, Charles R Giardina, Elliptic Fourier features of a closed contour, Computer Graphics and Image Processing, Volume 18, Issue 3, 1982, Pages 236-258. https://doi.org/10.1016/0146-664X(82)90034-X
2. Burger, W., Burge, M.J. (2013). Fourier Shape Descriptors. In: Principles of Digital Image Processing. Undergraduate Topics in Computer Science. Springer, London. https://doi.org/10.1007/978-1-84882-919-0_6
3. pyefd: Python implementation of "Elliptic Fourier Features of a Closed Contour". https://github.com/hbldh/pyefd

# 5 Implementation details
## 5.1 Description of a Closed Contour
Any continuous closed curve $C$ in the 2D plane can be expressed as a function $f:\mathbb{R} \rightarrow \mathbb{R}^2$, with

$$
f(t)=\begin{pmatrix} x(t) \\ y(t) \end{pmatrix}
$$

with the continuous parameter $t$ being varied over the range $[0,T]$ and $f(0)=f(T)$. Note that $x(t)$ and $y(t)$ are independent, real-valued functions, and $t$ is typically the path length along the curve.

Sampling a closed curve $C$ at $K$ randomly spaced positions $t_0, t_1, ..., t_p, ... t_{K-1}$, with $\Delta t_p = t_p-t_{p-1}$, resulting a closed contour with a sequence of discrete 2D coordinates $V=(\boldsymbol{v}_0, \boldsymbol{v}_1, ..., \boldsymbol{v}_p, ..., \boldsymbol{v}_{K-1})$, with

$$
\boldsymbol{v}_p=\begin{pmatrix} x(t_p) \\ y(t_p) \end{pmatrix}
$$

Since the contour is closed, thus

$$
\boldsymbol{v}_p=\boldsymbol{v}_{p+kT}
$$

for $0 \le p < K$ and any $k \in \mathbb{Z}$.

Furthermore, a closed contour is typically regarded as **piecewise linear** when processing it using computer algorithm, which mean the curve between $\boldsymbol{v}_p$ and $\boldsymbol{v}_{p-1}$ is regarded as a straight line.

## 5.2 Fourier Expansion of $x(t)$ and $y(t)$
$x(t)$ is a periodic function over the range $[0,T]$, the Fourier series expandsion for $x(t)$ of the complete closed contour is defined as

$$
x(t)=A_0+\sum_{n=1}^{\infty}a_n cos\frac{2n\pi t}{T}+\sum_{n=1}^{\infty}b_nsin\frac{2n\pi t}{T}
$$

where

$$
\begin{aligned}
    A_0&=\frac{1}{T}\int_0^Tx(t)dt
    \\ a_n&=\frac{2}{T}\int_0^Tx(t)cos\frac{2n\pi t}{T}dt
    \\ b_n&=\frac{2}{T}\int_0^Tx(t)sin\frac{2n\pi t}{T}dt
\end{aligned}
$$

Note that a closed curve is regarded as piecewise linear, thus

$$
\begin{aligned}
    A_0 &=\frac{1}{T}\int_0^Tx(t)dt
    \\ &= \frac{1}{T}\sum_{p=1}^{K}\int_{t_{p-1}}^{t_{p}}x(t)dt
    \\ &= \frac{1}{T}\sum_{p=1}^{K}\int_{t_{p-1}}^{t_p}(\frac{x_{p}-x_{p-1}}{t_p-t_{p-1}}(t-t_{p-1})+x_{p-1}) dt
    \\ &=\frac{1}{T} \sum_{p=1}^{K}(\frac{x_p-x_{p-1}}{t_p-t_{p-1}}\frac{(t-t_{p-1})^2}{2}+x_{p-1}t) \Big | _{t_{p-1}}^{t_p}
    \\ &=\frac{1}{T}\sum_{p=1}^{K}\frac{(x_p+x_{p-1})}{2}(t_p-t_{p-1})
    \\ &=\frac{1}{T}\sum_{p=1}^{K}\frac{(x_p+x_{p-1})}{2}\Delta t_p
\end{aligned}
$$

The expression of $A_0$ looks quite different from the orginal paper (*Elliptic Fourier Features of a Closed Contour*), but the equation in the original paper can be simplified and they are the same.

and $a_n$ can also be obtain

$$
\begin{aligned}
    a_n &= \frac{2}{T}\int_0^Tx(t)cos\frac{2n\pi t}{T}dt
    \\ &=\frac{2}{T}\sum_{p=1}^{K}\int_{t_{p-1}}^{t_p}x(t)cos\frac{2n\pi t}{T}dt
    \\ &=\frac{2}{T}\sum_{p=1}^{K}\int_{t_{p-1}}^{t_p}(\frac{x_p-x_{p-1}}{t_p-t_{p-1}}(t-t_{p-1})+x_{p-1})cos\frac{2n\pi t}{T}dt
    \\ &=\frac{1}{n\pi}\sum_{p=1}^{K}\int_{t_{p-1}}^{t_p}(\frac{x_p-x_{p-1}}{t_p-t_{p-1}}(t-t_{p-1})+x_{p-1})d(sin\frac{2n\pi t}{T})
    \\ &= \frac{1}{n\pi}\sum_{p=1}^{K} \Big[(\frac{x_p-x_{p-1}}{t_p-t_{p-1}}(t-t_{p-1})+x_{p-1}) sin\frac{2n\pi t}{T} \Big |_{t_{p-1}}^{t_p} -\frac{x_p-x_{p-1}}{t_p-t_{p-1}}\int_{t_{p-1}}^{t_p}sin\frac{2n\pi t}{T}dt\Big]
    \\ &= \frac{1}{n\pi}\sum_{p=1}^{K} (x_p sin\frac{2n\pi t_p}{T}-x_{p-1}sin\frac{2n\pi t_{p-1}}{T})-\frac{1}{n\pi}\sum_{p=1}^{K}\frac{\Delta x_p}{\Delta t_p}\int_{t_{p-1}}^{t_p}sin\frac{2n\pi t}{T}dt
    \\ &= -\frac{1}{n\pi}\sum_{p=1}^{K}\frac{\Delta x_p}{\Delta t_p}\int_{t_{p-1}}^{t_p}sin\frac{2n\pi t}{T}dt
    \\ &= \frac{T}{2n^2\pi^2}\sum_{p=1}^{K}\frac{\Delta x_p}{\Delta t_p}\Big[cos\frac{2n\pi t_p}{T}-cos\frac{2n\pi t_{p-1}}{T}\Big]
\end{aligned}$$

Similarily $b_n$ can also be calculated as

$$
b_n = \frac{T}{2n^2\pi^2}\sum_{p=1}^{K}\frac{\Delta x_p}{\Delta t_p}\Big[sin\frac{2n\pi t_p}{T}-sin\frac{2n\pi t_{p-1}}{T}\Big]
$$

The same way, the Fourier series expandsion for $y(t)$ of the complete closed contour is defined as

$$
y(t)=C_0+\sum_{n=1}^{\infty}c_n cos\frac{2n\pi t}{T}+\sum_{n=1}^{\infty}d_nsin\frac{2n\pi t}{T}
$$

where

$$
C_0 =\frac{1}{T}\sum_{p=1}^{K}\frac{(y_p+y_{p-1})}{2}\Delta t_p
$$

and

$$
c_n = \frac{T}{2n^2\pi^2}\sum_{p=1}^{K}\frac{\Delta y_p}{\Delta t_p}\Big[cos\frac{2n\pi t_p}{T}-cos\frac{2n\pi t_{p-1}}{T}\Big]
$$

$$
d_n = \frac{T}{2n^2\pi^2}\sum_{p=1}^{K}\frac{\Delta y_p}{\Delta t_p}\Big[sin\frac{2n\pi t_p}{T}-sin\frac{2n\pi t_{p-1}}{T}\Big]
$$

## 5.3 Truncated Fourier Approximation of a Closed Contour
The truncated Fourier approximation of a closed contour can be written as

$$
\begin{aligned}
    x(t)&=A_0+\sum_{n=1}^NX_n(t)
    \\y(t)&=C_0+\sum_{n=1}^NY_n(t)
\end{aligned}
$$

where the components of $X_n$, $Y_n$ ($1\le n \le N$) are

$$
\begin{aligned}
    X_n(t)&=a_ncos\frac{2n\pi t}{T}+b_nsin\frac{2n\pi t}{T}
    \\Y_n(t)&=c_ncos\frac{2n\pi t}{T}+d_nsin\frac{2n\pi t}{T}
\end{aligned}
$$

It can also be expressed as matrix form

$$
\begin{bmatrix}
    X_n(t)
    \\ Y_n(t)
\end{bmatrix}=
\begin{bmatrix}
    a_n & b_n
    \\ c_n & d_n
\end{bmatrix}
\begin{bmatrix}
    cos\frac{2n\pi t}{T}
    \\sin\frac{2n\pi t}{T}
\end{bmatrix}
$$

## 5.4 Geometric Interpretation of Fourier Coefficients

### 5.4.1 $A_0$ and $C_0$ Correspond to Contour's Centroid
When the contour is regularly sampled, $\Delta t_p=t_p-t_{p-1}=\frac{T}{K}$, thus

$$
\begin{aligned}
    A_0&=\frac{1}{T}\sum_{p=1}^{K}\frac{(x_p+x_{p-1})}{2}\Delta t_p
    \\&=\frac{1}{T}\sum_{p=1}^{K}(x_p+x_{p-1})\frac{T}{K}
    \\&=\frac{1}{K}\sum_{p=0}^{K-1}x_p
    \\&=\bar{x}
    \\C_0&=\frac{1}{T}\sum_{p=1}^{K}\frac{(y_p+y_{p-1})}{2}\Delta t_p
    \\&=\frac{1}{T}\sum_{p=1}^{K}(y_p+y_{p-1})\frac{T}{K}
    \\&=\frac{1}{K}\sum_{p=0}^{K-1}y_p
    \\&=\bar{y}
\end{aligned}
$$

$A_0$ and $C_0$ is simply the average of x and y coordinate when the contour is regularly sampled.

### 5.4.2 $a_n$, $b_n$, $c_n$ and $d_n$ Correspond to Ellipse
The $n$ coefficients contribute to

$$
\begin{aligned}
    X_n(t)&=a_ncos\frac{2n\pi t}{T}+b_nsin\frac{2n\pi t}{T}
    \\Y_n(t)&=c_ncos\frac{2n\pi t}{T}+d_nsin\frac{2n\pi t}{T}
\end{aligned}
$$

By removing $cos\frac{2n\pi t}{T}$ and $sin\frac{2n\pi t}{T}$ utilizing the equation $cos\frac{2n\pi t}{T} + sin\frac{2n\pi t}{T} =1$, it is easy to get that

$$
(c_n^2+d_n^2)X_n(t)^2+(a_n^2+b_n^2)Y_n(t)^2-2(a_nc_n+b_nd_n)X_n(t)Y_n(t)-(a_nd_n-b_nc_n)^2=1
$$

It is obvious that the contour constructed by $X_n(t)$ and $Y_n(t)$ is **an ellipse with its center coinciding with the origin of the coordinate system**.

## 5.5 Invariance of Start Point, Translation, Rotation and Scale

### 5.5.1 Invariance of Start Point
A start point displaced $\lambda$ units in the direction of rotation around the contour from the original start point is written as

$$
\begin{aligned}
    X_n^*(t^*)&=a_n^*cos\frac{2n\pi t^*}{T}+b_n^*sin\frac{2n\pi t^*}{T}
    \\Y_n^*(t^*)&=c_n^*cos\frac{2n\pi t^*}{T}+d_n^*sin\frac{2n\pi t^*}{T}
\end{aligned}
$$

It can also be written as

$$
\begin{aligned}
    X_n(t^*+\lambda)&=a_ncos\frac{2n\pi (t^*+\lambda)}{T}+b_nsin\frac{2n\pi (t^*+\lambda)}{T}
    \\&=(a_ncos\frac{2n\pi\lambda}{T}+b_nsin\frac{2n\pi\lambda}{T})cos\frac{2n\pi t^*}{T}+(-a_nsin\frac{2n\pi\lambda}{T}+b_ncos\frac{2n\pi\lambda}{T})sin\frac{2n\pi t^*}{T}
    \\Y_n(t^*+\lambda)&=c_ncos\frac{2n\pi (t^*+\lambda)}{T}+d_nsin\frac{2n\pi (t^*+\lambda)}{T}
    \\&=(c_ncos\frac{2n\pi\lambda}{T}+d_nsin\frac{2n\pi\lambda}{T})cos\frac{2n\pi t^*}{T}+(-c_nsin\frac{2n\pi\lambda}{T}+d_ncos\frac{2n\pi\lambda}{T})sin\frac{2n\pi t^*}{T}
\end{aligned}
$$

Thus

$$
\begin{aligned}
    a_n^*&=a_ncos\frac{2n\pi\lambda}{T}+b_nsin\frac{2n\pi\lambda}{T}
    \\b_n^*&=-a_nsin\frac{2n\pi\lambda}{T}+b_ncos\frac{2n\pi\lambda}{T}
    \\c_n^*&=c_ncos\frac{2n\pi\lambda}{T}+d_nsin\frac{2n\pi\lambda}{T}
    \\d_n^*&=-c_nsin\frac{2n\pi\lambda}{T}+d_ncos\frac{2n\pi\lambda}{T}
\end{aligned}
$$

which can be written as matrix form as

$$
\begin{bmatrix}
    a_n^* & c_n^*
    \\b_n^* & d_n^*
\end{bmatrix}=
\begin{bmatrix}
    cos\frac{2n\pi \lambda}{T} & sin\frac{2n\pi \lambda}{T}
    \\-sin\frac{2n\pi \lambda}{T} & cos\frac{2n\pi \lambda}{T}
\end{bmatrix}
\begin{bmatrix}
    a_n & c_n
    \\b_n & d_n
\end{bmatrix}
$$

#### 5.5.1.1 The start point invariance method in original paper
The point on the first semimajor axis of the first Fourier coefficients ellipse is selected as the start point. The first Fourier coefficients ellipse is written as

$$
\begin{aligned}
    X_1&=a_1cos\theta+b_1sin\theta
    \\Y_1&=c_1cos\theta+d_1sin\theta
\end{aligned}
$$

The point on the first semimajor axis is equivalent to find the maximum of $\sqrt{X_1^2+Y_1^2}$, thus

$$
\begin{aligned}
    \frac{d \sqrt{X_1^2+Y_1^2}}{d\theta}&=\frac{1}{2\sqrt{X_1^2+Y_1^2}}(2X_1\frac{dX_1}{d\theta}+2Y_1\frac{dY_1}{d\theta})
    \\&=\frac{1}{\sqrt{X_1^2+Y_1^2}}((a_1cos\theta+b_1sin\theta)(-a_1sin\theta+b_1cos\theta)+(c_1cos\theta+d_1sin\theta)(-c_1sin\theta+d_1cos\theta))
\end{aligned}
$$

Let $\frac{d \sqrt{X_1^2+Y_1^2}}{d\theta}=0$, we get

$$
tan 2 \theta = \frac{2tan \theta}{1-tan^2\theta}=\frac{2(a_1b_1+c_1d_1)}{a_1^2-b_1^2+c_1^2-d_1^2}
$$

which yeilds

$$
\theta_1=\frac{1}{2}arctan\Big[\frac{2(a_1b_1+c_1d_1)}{a_1^2-b_1^2+c_1^2-d_1^2}\Big]
$$

where $0\le \theta_1 < \pi$.

#### 5.5.1.2 The start point invariance method in the code
Ellipse has two semimajor axis, sometimes it is difficult to determine the semimajor axis and the normalized coefficients have -1 multiplier differences
Thus, the point having the maimum distance from the centroid $(A_0, C_0)$ is selected as the start point.

The Fourier coefficients that are correct for the start point is now

$$
\begin{bmatrix}
    a_n^* & c_n^*
    \\b_n^* & d_n^*
\end{bmatrix}=
\begin{bmatrix}
    cos(n\theta_1) & sin(n\theta_1)
    \\-sin(n\theta_1) & cos(n\theta_1)
\end{bmatrix}
\begin{bmatrix}
    a_n & c_n
    \\b_n & d_n
\end{bmatrix}
$$

### 5.5.2 Invariance of Trannslation
$A_0$ and $C_0$ is simply the average of x and y coordinate when the contour is regularly sampled. To make Fourier coefficients invariant against translation, it is thus sufficient to zero $A_0$ and $C_0$, thereby shifting the shape's center to the origin of the coordinate system. Alternatively, it is achieved by simply ignoring coefficient $A_0$ and $C_0$.

### 5.5.3 Invariance of Rotation
The start point variance removed $X_n^*$ and $Y_n^*$ are expressed in matrix form

$$
\begin{bmatrix}
    X_n^*(t^*)
    \\ Y_n^*(t^*)
\end{bmatrix}=
\begin{bmatrix}
    a_n^* & b_n^*
    \\ c_n^* & d_n^*
\end{bmatrix}
\begin{bmatrix}
    cos\frac{2n\pi t^*}{T}
    \\sin\frac{2n\pi t^*}{T}
\end{bmatrix}
$$

The effect of anti-clockwise axial rotation on the Fourier coefficients is readily apparent

$$
\begin{bmatrix}
    X_n^{**}(t^*)
    \\Y_n^{**}(t^*)
\end{bmatrix}=
\begin{bmatrix}
    cos\psi & -sin\psi
    \\sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix}
    X_n^*(t^*)
    \\Y_n^*(t^*)
\end{bmatrix}=
\begin{bmatrix}
    cos\psi & -sin\psi
    \\sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix}
    a_n^* & b_n^*
    \\ c_n^* & d_n^*
\end{bmatrix}
\begin{bmatrix}
    cos\frac{2n\pi t^*}{T}
    \\sin\frac{2n\pi t^*}{T}
\end{bmatrix}
$$

Note that

$$
\begin{bmatrix}
    X_n^{**}(t^*)
    \\ Y_n^{**}(t^*)
\end{bmatrix}=
\begin{bmatrix}
    a_n^{**} & b_n^{**}
    \\ c_n^{**} & d_n^{**}
\end{bmatrix}
\begin{bmatrix}
    cos\frac{2n\pi t^*}{T}
    \\sin\frac{2n\pi t^*}{T}
\end{bmatrix}
$$

Therefore, it is easy to get

$$
\begin{bmatrix}
    a_n^{**} & b_n^{**}
    \\ c_n^{**} & d_n^{**}
\end{bmatrix}=
\begin{bmatrix}
    cos\psi & -sin\psi
    \\sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix}
    a_n^* & b_n^*
    \\ c_n^* & d_n^*
\end{bmatrix}=
\begin{bmatrix}
    cos\psi & -sin\psi
    \\sin\psi & cos\psi
\end{bmatrix}
\begin{bmatrix}
    a_n & b_n
    \\c_n & d_n
\end{bmatrix}
\begin{bmatrix}
    cos(n\theta_1) & -sin(n\theta_1)
    \\sin(n\theta_1) & cos(n\theta_1)
\end{bmatrix}
$$

#### 5.5.3.1 The rotation invariance method in original paper
The semimajor axis of the first Fourier coefficients ellipse is selected to aligned with horizontal axis of the coordiante system. Thus, the axial rotation angle is obvious

$$
\begin{aligned}
    \psi_1&=arctan\Big[\frac{Y_1^*(0)}{X_1^*(0)}\Big]
    \\&=arctan\frac{c_1^*}{a_1^*}
\end{aligned}
$$

where $0\le \psi_1 < 2\pi$. We need to rotate $-\psi$ to obtain rotation invariance.

#### 5.5.3.2 The rotation invariance method in the code
The point having the maimum distance from the centroid $(A_0, C_0)$ is selected is selected to aligned with horizontal axis of the coordiante system.Thus, the axial rotation angle is obvious

$$
\begin{aligned}
    \psi_1&=arctan\Big[\frac{y(0)}{x(0)}\Big]
    \\&=arctan\frac{\sum_{i=1}^Nc_i^*}{\sum_{i=1}^Na_i^*}
\end{aligned}
$$

Thus, it is easy to get

$$
\begin{bmatrix}
    a_n^{**} & b_n^{**}
    \\ c_n^{**} & d_n^{**}
\end{bmatrix}=
\begin{bmatrix}
    cos(-\psi_1) & -sin(-\psi_1)
    \\sin(-\psi_1) & cos(-\psi_1)
\end{bmatrix}
\begin{bmatrix}
    a_n & b_n
    \\c_n & d_n
\end{bmatrix}
\begin{bmatrix}
    cos(n\theta_1) & -sin(n\theta_1)
    \\sin(n\theta_1) & cos(n\theta_1)
\end{bmatrix}
$$

### 5.5.4 Invariance of Scale
The independence of scale is achieved by dividing each of the coefficients by the magnitude of the simimajor axis.

The magnitude of the semimajor axis is

$$
\sqrt{X_1^*(0)^2+Y_1^*(0)^2}=\sqrt{a_1^{*2}+b_1^{*2}}
$$

and

$$
s_1=\frac{1}{\sqrt{a_1^{*2}+b_1^{*2}}}
$$

The Fourier coefficients corrected by scale is illustrated as

$$
\begin{bmatrix}
    a_n^{***} & b_n^{***}
    \\c_n^{***} & d_n^{***}
\end{bmatrix}=
s_1
\begin{bmatrix}
    a_n^{**} & b_n^{**}
    \\ c_n^{**} & d_n^{**}
\end{bmatrix}
$$

### 5.5.5 Invariance of Start Point, Rotation and Scale
The invariance of start point, rotation and scale can be expressed as

$$
\begin{bmatrix}
    a_n^{***} & b_n^{***}
    \\c_n^{***} & d_n^{***}
\end{bmatrix}=
s_1
\begin{bmatrix}
    cos(-\psi_1) & -sin(-\psi_1)
    \\sin(-\psi_1) & cos(-\psi_1)
\end{bmatrix}
\begin{bmatrix}
    a_n & b_n
    \\c_n & d_n
\end{bmatrix}
\begin{bmatrix}
    cos(n\theta_1) & -sin(n\theta_1)
    \\sin(n\theta_1) & cos(n\theta_1)
\end{bmatrix}
$$